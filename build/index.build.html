<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>web-socket demo</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

    </head><div hidden="" by-polymer-bundler=""><link rel="import" href="../../polymer/polymer.html">

<link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
<link rel="import" href="../../iron-demo-helpers/demo-snippet.html">
<link rel="import" href="../../iron-input/iron-input.html">
<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../../paper-input/paper-input-container.html">
<link rel="import" href="../../paper-input/paper-input-error.html">
<link rel="import" href="../../paper-button/paper-button.html">

<dom-module id="web-socket" assetpath="../">
  <template strip-whitespace="">
    <style>
      :host() {
        display: none;
      }
    </style>
  </template>

  <script>
    // https://developer.mozilla.org/en-US/docs/Web/API/WebSocket#Ready_state_constants
    const CONNECTING = 0;
    const OPEN = 1;
    const CLOSING = 2;
    const CLOSED = 3;

    class WebSocket extends Polymer.Element {

      static get is() {
        return 'web-socket';
      }

      static get properties() {
        return {
          auto: {
            type: Boolean,
            value: false
          },
          url: {
            type: String,
            notify: true
          },
          protocols: {
            type: Array,
            value: []
          },
          state: {
            type: Number,
            notify: true,
            readOnly: true
          },
          lastRequest: {
            type: Object,
            notify: true,
            readOnly: true
          },
          lastResponse: {
            type: Object,
            notify: true,
            readOnly: true
          },
          /**
           * last web-socket error, if any
           * @type {Object}
           */
          lastError: {
            type: Object,
            notify: true,
            readOnly: true
          },
          ws: {
            type: Object,
            readOnly: true
          },
          verbose: {
            type: Boolean,
            value: false
          }
        };
      }

      /** lifecycle functions */

      connectedCallback() {

        if (this.auto) {
          this._getWebSocket();
        }
      }

      disconnectedCallback() {
        close();
      }

      /** callback functions */

      onOpen(event) {
        this._notifyStateChange();
        if (this.verbose) {
          console.info(this.id + " : WebSocket to [%s] established.", this.url, event);
        }
      }

      onClose(event) {
        this._notifyStateChange();
        if (event.wasClean === true) {
          if (this.verbose) {
            console.info(this.id + " : WebSocket [%s] closed.", this.url, event);
          }
        } else {
          if (this.verbose) {
            console.warn(this.id + " : WebSocket [%s] was closed.", this.url, event);
          }
        }
      }

      onMessage(event) {
        if (this.verbose) {
          console.info(this.id + " : WebSocket [%s] received message.", this.url, event);
        }
        this._setLastResponse(JSON.parse(event.data));
      }

      onError(event) {
        if (this.verbose) {
          console.error(this.id + " : WebSocket to [%s] returns error.", this.url, event);
        }
        this._setLastError(event);
      }

      /** public methods */

      open() {
        this._getWebSocket();
      }

      send(object) {

        var _ws = this._getWebSocket();
        if (_ws != null) {
          if (_ws.readyState === OPEN) {
            try {
              _ws.send(JSON.stringify(object));
            } catch (err) {
              if (this.verbose) {
                console.error(this.id + " : Failed to send message to [%s] WebSocket.", this.url, err);
              }
              this._setLastError(object);
            }
            this._setLastRequest(object);
          } else {
            if (this.verbose) {
              console.warn(this.id + " : WebSocket connection to [%s] isn't open.", this.url);
            }
          }
        } else {
          if (this.verbose) {
            console.error(this.id + " : WebSocket connection to [%s] is null.", this.url);
          }
        }
      }

      close() {

        var _ws = this._getWebSocket();
        if (_ws.readyState === OPEN) {
          _ws.close();
          this._notifyStateChange();
        } else {
          if (this.verbose) {
            console.warn(this.id + ": WebSocket connection isn't open.", _ws);
          }
        }
      }

      /** private methods */

      _notifyStateChange() {
        this._setState(this.ws.readyState);
      }

      _getWebSocket() {

        if (this.ws === null || this.ws === undefined || this.ws != null && this.ws.readyState === CLOSED) {
          if (this.url === undefined) {
            if (this.verbose) {
              console.error(this.id + " : Please provide a valid WebSocket url [%s].", this.url);
            }
          } else {
            this._setWs(this._createWebSocket());
            this._notifyStateChange();
          }
        }
        return this.ws;
      }

      _createWebSocket() {

        var _ws = null;
        try {
          _ws = new window.WebSocket(this.url, this.protocols);
          // bind socket events to component events
          _ws.onopen = this.onOpen.bind(this);
          _ws.onclose = this.onClose.bind(this);
          _ws.onmessage = this.onMessage.bind(this);
          _ws.onerror = this.onError.bind(this);
        } catch (err) {
          if (this.verbose) {
            console.error(this.id + " : Establishing WebSocket connection to [%s] failed.", this.url, err);
          }
          this._setLastError(err);
        }
        return _ws;
      }
    }
    window.customElements.define(WebSocket.is, WebSocket);
  </script>
</dom-module>
<dom-module id="echo-demo">
  <template strip-whitespace="">
    <style>
      :host() {
        display: inline-block;
      }
      .container {
        display: inline-flex;
        align-items: center;
        width: 100%;
      }
      paper-button#connect {
        padding-left: 24px;
        padding-right: 24px;
        background-color: var(--state-color, var(--paper-orange-500));
      }
      input {
        outline: none;
        box-shadow: none;
        padding: 0;
        width: 100%;
        max-width: 100%;
        background: transparent;
        border: none;
        color: var(--paper-input-container-input-color, var(--primary-text-color));
        -webkit-appearance: none;
        text-align: inherit;
        vertical-align: bottom;
        /* Firefox sets a min-width on the input, which can cause layout issues */
        min-width: 0;
        @apply --paper-font-subhead;
        @apply --paper-input-container-input;
      }
      paper-input-container {
        width: 100%;
      }
      paper-input {
        width: 100%;
      }
    </style>
    <web-socket id="ws" auto="" url="[[url]]" state="{{state}}" last-response="{{response}}" last-error="{{error}}" verbose="">
    </web-socket>
    <div class="container">
      <paper-input-container always-float-label="" auto-validate="" attr-for-value="url">
        <label slot="label">URL</label>
        <iron-input slot="input" bind-value="{{url}}">
          <input value="{{url::input}}">
        </iron-input>
        <paper-input-error id="error" slot="add-on">Failed to establish connection.</paper-input-error>
      </paper-input-container>
      <paper-button id="connect" raised="" on-click="_toggleConnectionState"></paper-button>
    </div>
    <template is="dom-repeat" items="[[messages]]">
      <pre>[[item.author]]: [[item.text]]</pre>
    </template>
    <paper-input id="input" autofocus="" value="{{message}}"></paper-input>
    <paper-button raised="" on-click="_send">Send</paper-button>
  </template>
  <script>
    class EchoDemo extends Polymer.Element {

      static get is() {
        return 'echo-demo';
      }

      static get properties() {
        return {
          url: {
            type: String,
            value: 'wss://echo.websocket.org/',
            observer: '_handleUrlChanges',
            notify: true
          },
          messages: {
            type: Array,
            value: [],
            notify: true
          },
          state: {
            type: Number,
            observer: '_handleStateChanges',
            notify: true
          },
          response: {
            type: Object,
            observer: '_handleResponse'
          },
          error: {
            type: Object,
            observer: '_handleError'
          }
        };
      }

      _toggleConnectionState() {

        if (this.state === 1) {
          this.$.ws.close();
        } else {
          this.$.ws.open();
        }
        this.$.input.focus();
      }

      _send() {

        this.$.ws.send(this.message);
        this.push('messages', {
          author: 'you',
          text: this.message
        });
        this.message = '';
        this.$.input.focus();
      }

      _handleUrlChanges() {

        if (this.$.ws.state === 1) {
          this.$.ws.close();
        }
        // overwrite any error messages before
        this.$.error.update({invalid: false});
      }

      _handleStateChanges() {

        var _color = 'var(--paper-orange-500)';
        switch (this.state) {
          case 1:
            _color = 'var(--paper-green-500)';
            this.$.connect.innerHTML = 'ON';
            break;
          case 3:
            _color = 'var(--paper-red-500)';
            this.$.connect.innerHTML = 'OFF';
            break;
          default:
            this.$.connect.innerHTML = '[x]';
        }
        this.updateStyles({
          '--state-color': _color
        });
      }

      _handleResponse() {

        this.push('messages', {
          author: 'server',
          text: this.response
        });
      }

      _handleError() {

        this.$.error.update({invalid: true});
      }
    }
    window.customElements.define(EchoDemo.is, EchoDemo);
  </script>
</dom-module>
</div><custom-style>
      <style is="custom-style" include="demo-pages-shared-styles">
      </style>
    </custom-style>
  
  
    <div class="vertical-section-container centered">
      <h3>Web-socket echo server</h3>
      <demo-snippet>
        <template>
          <echo-demo></echo-demo>
        </template>
      </demo-snippet>
    </div>
  

</html>