<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module id="web-socket">
  <template strip-whitespace>
    <style>
      :host() {
        display: none;
      }
    </style>
  </template>

  <script>
    // https://developer.mozilla.org/en-US/docs/Web/API/WebSocket#Ready_state_constants
    const CONNECTING = 0;
    const OPEN = 1;
    const CLOSING = 2;
    const CLOSED = 3;

    class WebSocket extends Polymer.Element {

      static get is() {
        return 'web-socket';
      }

      static get properties() {
        return {
          auto: {
            type: Boolean,
            value: false
          },
          url: {
            type: String,
            notify: true
          },
          protocols: {
            type: Array,
            value: []
          },
          state: {
            type: Number,
            notify: true,
            readOnly: true
          },
          lastRequest: {
            type: Object,
            notify: true,
            readOnly: true
          },
          lastResponse: {
            type: Object,
            notify: true,
            readOnly: true
          },
          /**
           * last web-socket error, if any
           * @type {Object}
           */
          lastError: {
            type: Object,
            notify: true,
            readOnly: true
          },
          ws: {
            type: Object,
            readOnly: true
          },
          verbose: {
            type: Boolean,
            value: false
          }
        };
      }

      /** lifecycle functions */

      connectedCallback() {

        if (this.auto) {
          this._getWebSocket();
        }
      }

      disconnectedCallback() {
        close();
      }

      /** callback functions */

      onOpen(event) {
        this._notifyStateChange();
        if (this.verbose) {
          console.info(this.id + " : WebSocket to [%s] established.", this.url, event);
        }
      }

      onClose(event) {
        this._notifyStateChange();
        if (event.wasClean === true) {
          if (this.verbose) {
            console.info(this.id + " : WebSocket [%s] closed.", this.url, event);
          }
        } else {
          if (this.verbose) {
            console.warn(this.id + " : WebSocket [%s] was closed.", this.url, event);
          }
        }
      }

      onMessage(event) {
        if (this.verbose) {
          console.info(this.id + " : WebSocket [%s] received message.", this.url, event);
        }
        this._setLastResponse(JSON.parse(event.data));
      }

      onError(event) {
        if (this.verbose) {
          console.error(this.id + " : WebSocket to [%s] returns error.", this.url, event);
        }
        this._setLastError(event);
      }

      /** public methods */

      open() {
        this._getWebSocket();
      }

      send(object) {

        var _ws = this._getWebSocket();
        if (_ws != null) {
          if (_ws.readyState === OPEN) {
            try {
              _ws.send(JSON.stringify(object));
            } catch (err) {
              if (this.verbose) {
                console.error(this.id + " : Failed to send message to [%s] WebSocket.", this.url, err);
              }
              this._setLastError(object);
            }
            this._setLastRequest(object);
          } else {
            if (this.verbose) {
              console.warn(this.id + " : WebSocket connection to [%s] isn't open.", this.url);
            }
          }
        } else {
          if (this.verbose) {
            console.error(this.id + " : WebSocket connection to [%s] is null.", this.url);
          }
        }
      }

      close() {

        var _ws = this._getWebSocket();
        if (_ws.readyState === OPEN) {
          _ws.close();
          this._notifyStateChange();
        } else {
          if (this.verbose) {
            console.warn(this.id + ": WebSocket connection isn't open.", _ws);
          }
        }
      }

      /** private methods */

      _notifyStateChange() {
        this._setState(this.ws.readyState);
      }

      _getWebSocket() {

        if (this.ws === null || this.ws === undefined || this.ws != null && this.ws.readyState === CLOSED) {
          if (this.url === undefined) {
            if (this.verbose) {
              console.error(this.id + " : Please provide a valid WebSocket url [%s].", this.url);
            }
          } else {
            this._setWs(this._createWebSocket());
          }
        }
        return this.ws;
      }

      _createWebSocket() {

        var _ws = null;
        try {
          _ws = new window.WebSocket(this.url, this.protocols);
          this._notifyStateChange();
          // bind socket events to component events
          _ws.onopen = this.onOpen.bind(this);
          _ws.onclose = this.onClose.bind(this);
          _ws.onmessage = this.onMessage.bind(this);
          _ws.onerror = this.onError.bind(this);
        } catch (err) {
          if (this.verbose) {
            console.error(this.id + " : Establishing WebSocket connection to [%s] failed.", this.url, err);
          }
          this._setLastError(err);
        }
        return _ws;
      }
    }
    window.customElements.define(WebSocket.is, WebSocket);
  </script>
</dom-module>
