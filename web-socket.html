<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module id="web-socket">
  <template strip-whitespace>
    <style>
		  :host() {
			  display: none;
		  }
	   </style>
  </template>

  <script>

    // https://developer.mozilla.org/en-US/docs/Web/API/WebSocket#Ready_state_constants
    const CONNECTING = 0;
    const OPEN = 1;
    const CLOSING = 2;
    const CLOSED = 3;

    class WebSocket extends Polymer.Element {

      static get is() { return 'web-socket'; }

      static get properties() {
        return {
          auto: {
            type: Boolean,
            value: false
          },
          url: {
            type: String
          },
          protocols: {
            type: Array,
            value: []
          },
          state: {
            type: Number,
            notify: true
          },
          lastRequest: {
            type: Object,
            notify: true,
            readOnly: true
          },
          lastResponse: {
            type: Object,
            notify: true,
            readOnly: true
          },
          ws: {
            type: Object
          }
        };
      }

      /** lifecycle functions */

      connectedCallback() {

        if (this.auto) {
          this._getWebSocket();
        }
      }

      disconnectedCallback() {
        close();
      }

      /** callback functions */

      onOpen(event) {
        this._notifyStateChange();
        console.info(this.id + " : WebSocket to [%s] established.", this.url, event);
      }

      onClose(event) {
        this._notifyStateChange();
        if (event.wasClean === true) {
          console.info(this.id + " : WebSocket [%s] closed.", this.url, event);
        } else {
          console.warn(this.id + " : WebSocket [%s] was closed.", this.url, event);
        }
      }

      onMessage(event) {
        console.info(this.id + " : WebSocket [%s] received message.", this.url, event);
        this._setLastResponse(JSON.parse(event.data));
      }

      onError(event) {
        console.error(this.id + " : WebSocket to [%s] returns error.", this.url, event);
      }

      /** public methods */

      open() {
        this._getWebSocket();
      }

      send(object) {

        var _ws = this._getWebSocket();
        if (_ws != null) {
          if (_ws.readyState === OPEN) {
            try {
              _ws.send(JSON.stringify(object));
              this._setLastRequest(object);
            } catch(err) {
              console.error(this.id + " : Failed to send message to [%s] WebSocket.", this.url, err);
            }
          } else {
            console.warn(this.id + " : WebSocket connection to [%s] isn't open.", this.url);
          }
        } else {
          console.error(this.id + " : WebSocket connection to [%s] is null.", this.url);
        }
      }

      close() {

        var _ws = this._getWebSocket();
        if (_ws.readyState === OPEN) {
          _ws.close();
        } else {
          console.warn(this.id + ": WebSocket connection isn't open.", _ws);
        }
      }

      /** private methods */

      _notifyStateChange() {
        this.state = this.ws.readyState;
      }

      _getWebSocket() {

        if (this.ws === null || this.ws === undefined || this.ws != null && this.ws.readyState === CLOSED) {
          if (this.url === undefined) {
            console.error(this.id + " : Please provide a valid WebSocket url [%s].", this.url);
          } else {
            try {
              this.ws = this._createWebSocket();
            } catch(err) {
              console.error(this.id + " : Establishing WebSocket connection to [%s] failed.", this.url, err);
            }
            this._notifyStateChange();
          }
        }
        return this.ws;
      }

      _createWebSocket() {

        var _ws = new window.WebSocket(this.url, this.protocols);
        // bind socket events to component events
        _ws.onopen = this.onOpen.bind(this);
        _ws.onclose = this.onClose.bind(this);
        _ws.onmessage = this.onMessage.bind(this);
        _ws.onerror = this.onError.bind(this);
        return _ws;
      }
    }
    window.customElements.define(WebSocket.is, WebSocket);
  </script>
</dom-module>
